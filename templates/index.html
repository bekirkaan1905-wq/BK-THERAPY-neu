<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BK Therapy - Rechnung</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif; 
            background: linear-gradient(180deg, #e0e0e0 0%, #c0c0c0 50%, #a0a0a0 100%);
            min-height: 100vh; 
            padding: 20px; 
            color: #1a1a1a;
        }
        .container { max-width: 500px; margin: 0 auto; }
        
        h1 { 
            text-align: center; 
            margin-bottom: 5px; 
            font-weight: 600;
            font-size: 2rem;
            background: linear-gradient(180deg, #333 0%, #666 40%, #333 60%, #000 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 4px;
            text-transform: uppercase;
        }
        .subtitle { 
            text-align: center; 
            color: #555; 
            margin-bottom: 30px; 
            font-weight: 400;
            letter-spacing: 2px;
            font-size: 0.85rem;
        }
        
        .card { 
            background: linear-gradient(145deg, #f5f5f5 0%, #e0e0e0 50%, #d0d0d0 100%);
            border-radius: 20px; 
            padding: 24px; 
            margin-bottom: 20px; 
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.2),
                0 1px 0 rgba(255,255,255,0.8) inset,
                0 -1px 0 rgba(0,0,0,0.1) inset;
        }
        
        .card-title { 
            background: linear-gradient(180deg, #222 0%, #555 50%, #222 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700; 
            margin-bottom: 20px;
            font-size: 0.9rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .form-group { margin-bottom: 18px; position: relative; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        label { 
            display: block; 
            color: #444; 
            font-size: 0.75rem; 
            margin-bottom: 8px; 
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        input, select { 
            width: 100%; 
            padding: 14px 16px; 
            border: 1px solid rgba(0,0,0,0.15); 
            border-radius: 12px; 
            background: linear-gradient(145deg, #fff 0%, #f0f0f0 100%);
            color: #1a1a1a; 
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.06),
                0 1px 0 rgba(255,255,255,0.8);
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: rgba(0,0,0,0.3);
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.1),
                0 0 0 3px rgba(0,0,0,0.1);
        }
        input::placeholder { color: #999; }
        select option { background: #fff; color: #1a1a1a; }
        
        .position { 
            background: linear-gradient(145deg, #e8e8e8 0%, #d8d8d8 100%);
            border-radius: 16px; 
            padding: 18px; 
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 
                0 4px 15px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.5);
        }
        .pos-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .pos-title { 
            color: #333; 
            font-weight: 700;
            font-size: 0.85rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .btn-del { 
            background: linear-gradient(145deg, #ff6b6b, #ee5a5a);
            border: none; 
            color: #fff; 
            width: 32px; 
            height: 32px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255,82,82,0.3);
        }
        .btn-del:hover { 
            background: linear-gradient(145deg, #ff5252, #dd4a4a);
            transform: scale(1.05);
        }
        
        .btn-add { 
            width: 100%; 
            padding: 14px; 
            background: linear-gradient(145deg, #e0e0e0, #c8c8c8);
            border: 2px dashed #999; 
            border-radius: 12px; 
            color: #555; 
            cursor: pointer; 
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            letter-spacing: 1px;
        }
        .btn-add:hover { 
            border-color: #666;
            color: #333;
            background: linear-gradient(145deg, #e8e8e8, #d0d0d0);
        }
        
        .total-box { 
            text-align: right; 
            padding: 20px; 
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            border-radius: 14px; 
            margin-top: 20px;
            box-shadow: 
                0 4px 20px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .total-label { 
            color: #888; 
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        .total-value { 
            font-size: 2rem; 
            font-weight: 300;
            background: linear-gradient(180deg, #fff 0%, #ccc 50%, #999 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
        }
        
        .btn-submit { 
            width: 100%; 
            padding: 18px; 
            background: linear-gradient(145deg, #333 0%, #1a1a1a 50%, #333 100%);
            border: none; 
            border-radius: 14px; 
            color: #e0e0e0; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer; 
            margin-top: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 
                0 6px 20px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .btn-submit:hover {
            background: linear-gradient(145deg, #444 0%, #222 50%, #444 100%);
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.15);
        }
        .btn-submit:active { transform: scale(0.98); }
        
        .btn-today { 
            padding: 14px 20px; 
            background: linear-gradient(145deg, #333, #1a1a1a);
            border: none; 
            border-radius: 12px; 
            color: #e0e0e0; 
            font-weight: 600; 
            cursor: pointer; 
            white-space: nowrap;
            font-size: 0.85rem;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-today:hover {
            background: linear-gradient(145deg, #444, #222);
        }
        .btn-today:active { transform: scale(0.95); }
        
        .date-row { display: grid; grid-template-columns: 1fr auto; gap: 12px; }
        
        .autocomplete-list { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: #fff;
            border: 1px solid #ccc; 
            border-radius: 12px; 
            max-height: 180px; 
            overflow-y: auto; 
            z-index: 100; 
            display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-top: 5px;
        }
        .autocomplete-list.show { display: block; }
        .autocomplete-item { 
            padding: 14px 16px; 
            cursor: pointer; 
            border-bottom: 1px solid #eee;
            transition: all 0.2s ease;
        }
        .autocomplete-item:hover { 
            background: #f5f5f5;
        }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item strong { color: #222; }
        .autocomplete-item small { color: #666; }
        
        .saved-badge { 
            font-size: 0.65rem; 
            background: linear-gradient(90deg, #333, #1a1a1a);
            color: #e0e0e0; 
            padding: 3px 10px; 
            border-radius: 6px; 
            margin-left: 8px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #ddd; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>BK Therapy</h1>
        <p class="subtitle">Rechnung erstellen</p>

        <form id="myForm">
            <div class="card">
                <div class="card-title">Rechnungsdaten</div>
                <div class="form-group">
                    <label>Rechnungsnummer</label>
                    <input type="text" id="inv_nr" placeholder="2026-01" required>
                </div>
                <div class="form-group">
                    <label>Datum</label>
                    <div class="date-row">
                        <input type="date" id="inv_date" required>
                        <button type="button" class="btn-today" id="todayBtn">Heute</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Kunde <span id="customerBadge"></span></div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="c_name" placeholder="Kundenname" required autocomplete="off">
                    <div class="autocomplete-list" id="nameList"></div>
                </div>
                <div class="form-group">
                    <label>StraÃŸe</label>
                    <input type="text" id="c_street" placeholder="StraÃŸe Nr." autocomplete="off">
                    <div class="autocomplete-list" id="streetList"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>PLZ</label>
                        <input type="text" id="c_plz" placeholder="12345" autocomplete="off">
                        <div class="autocomplete-list" id="plzList"></div>
                    </div>
                    <div class="form-group">
                        <label>Stadt</label>
                        <input type="text" id="c_city" placeholder="Stadt" autocomplete="off">
                        <div class="autocomplete-list" id="cityList"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Positionen</div>
                <div id="pos_list"></div>
                <button type="button" class="btn-add" id="addBtn">+ Position hinzufÃ¼gen</button>
                <div class="total-box">
                    <div class="total-label">Gesamt</div>
                    <div class="total-value" id="total">0,00 â‚¬</div>
                </div>
            </div>

            <button type="submit" class="btn-submit">ðŸ“„ Rechnung erstellen</button>
        </form>
    </div>

<script>
var n = 0;
var customers = [];
var services = [];

function init() {
    loadData();
    document.getElementById('inv_date').valueAsDate = new Date();
    addPos();
    
    document.getElementById('addBtn').onclick = addPos;
    document.getElementById('myForm').onsubmit = submitForm;
    document.getElementById('todayBtn').onclick = setToday;
    
    setupAutocomplete('c_name', 'nameList', 'name');
    setupAutocomplete('c_street', 'streetList', 'street');
    setupAutocomplete('c_plz', 'plzList', 'plz');
    setupAutocomplete('c_city', 'cityList', 'city');
}

function setToday() {
    document.getElementById('inv_date').valueAsDate = new Date();
}

function loadData() {
    try {
        customers = JSON.parse(localStorage.getItem('bk_customers')) || [];
        services = JSON.parse(localStorage.getItem('bk_services')) || [];
    } catch(e) {
        customers = [];
        services = [];
    }
}

function saveCustomer() {
    var name = document.getElementById('c_name').value.trim();
    var street = document.getElementById('c_street').value.trim();
    var plz = document.getElementById('c_plz').value.trim();
    var city = document.getElementById('c_city').value.trim();
    
    if (!name) return;
    
    var existing = customers.findIndex(function(c) { return c.name.toLowerCase() === name.toLowerCase(); });
    var customer = { name: name, street: street, plz: plz, city: city };
    
    if (existing >= 0) {
        customers[existing] = customer;
    } else {
        customers.push(customer);
    }
    
    localStorage.setItem('bk_customers', JSON.stringify(customers));
}

function saveService(desc, duration) {
    if (!desc) return;
    
    var key = desc.toLowerCase();
    var existing = services.findIndex(function(s) { return s.desc.toLowerCase() === key; });
    var service = { desc: desc, duration: duration };
    
    if (existing >= 0) {
        services[existing] = service;
    } else {
        services.push(service);
    }
    
    localStorage.setItem('bk_services', JSON.stringify(services));
}

function setupAutocomplete(inputId, listId, field) {
    var input = document.getElementById(inputId);
    var list = document.getElementById(listId);
    
    input.addEventListener('input', function() {
        var val = this.value.toLowerCase();
        if (val.length < 1) {
            list.classList.remove('show');
            return;
        }
        
        var matches = [];
        for (var i = 0; i < customers.length; i++) {
            var c = customers[i];
            var fieldVal = c[field] || '';
            if (fieldVal.toLowerCase().indexOf(val) >= 0) {
                matches.push(c);
            }
        }
        
        if (matches.length === 0) {
            list.classList.remove('show');
            return;
        }
        
        var html = '';
        for (var j = 0; j < matches.length; j++) {
            var m = matches[j];
            html += '<div class="autocomplete-item" data-name="' + m.name + '" data-street="' + m.street + '" data-plz="' + m.plz + '" data-city="' + m.city + '">';
            html += '<strong>' + m.name + '</strong><br><small>' + m.street + ', ' + m.plz + ' ' + m.city + '</small>';
            html += '</div>';
        }
        
        list.innerHTML = html;
        list.classList.add('show');
        
        var items = list.querySelectorAll('.autocomplete-item');
        for (var k = 0; k < items.length; k++) {
            items[k].addEventListener('click', function() {
                document.getElementById('c_name').value = this.getAttribute('data-name');
                document.getElementById('c_street').value = this.getAttribute('data-street');
                document.getElementById('c_plz').value = this.getAttribute('data-plz');
                document.getElementById('c_city').value = this.getAttribute('data-city');
                list.classList.remove('show');
                document.getElementById('customerBadge').innerHTML = '<span class="saved-badge">Gespeichert</span>';
            });
        }
    });
    
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !list.contains(e.target)) {
            list.classList.remove('show');
        }
    });
}

function setupServiceAutocomplete(inputId) {
    var input = document.getElementById(inputId);
    if (!input) return;
    
    input.addEventListener('input', function() {
        var val = this.value.toLowerCase();
        if (val.length < 1) return;
        
        for (var i = 0; i < services.length; i++) {
            if (services[i].desc.toLowerCase().indexOf(val) >= 0) {
                var pos = this.closest('.position');
                if (pos && services[i].duration) {
                    var durInput = pos.querySelector('[id^="dur"]');
                    if (durInput && !durInput.value) {
                        durInput.value = services[i].duration;
                    }
                }
                break;
            }
        }
    });
}

function addPos() {
    n++;
    var html = '<div class="position" id="p' + n + '">' +
        '<div class="pos-header"><span class="pos-title">Position ' + n + '</span>' +
        '<button type="button" class="btn-del" onclick="delPos(' + n + ')">Ã—</button></div>' +
        '<div class="form-row">' +
        '<div class="form-group"><label>Behandlung</label>' +
        '<input type="text" id="desc' + n + '" placeholder="z.B. Massage" onchange="calc()"></div>' +
        '<div class="form-group"><label>Dauer</label>' +
        '<input type="text" id="dur' + n + '" placeholder="60 Min" onchange="calc()"></div>' +
        '</div>' +
        '<div class="form-row">' +
        '<div class="form-group"><label>Menge</label>' +
        '<input type="number" id="qty' + n + '" placeholder="1" value="1" step="1" onchange="calc()"></div>' +
        '<div class="form-group"><label>Preis â‚¬</label>' +
        '<input type="number" id="price' + n + '" placeholder="60" step="1" onchange="calc()"></div>' +
        '</div></div>';
    document.getElementById('pos_list').insertAdjacentHTML('beforeend', html);
    setupServiceAutocomplete('desc' + n);
}

function delPos(id) {
    var el = document.getElementById('p' + id);
    if (el && document.querySelectorAll('.position').length > 1) {
        el.remove();
        calc();
    }
}

function calc() {
    var sum = 0;
    var positions = document.querySelectorAll('.position');
    for (var i = 0; i < positions.length; i++) {
        var pos = positions[i];
        var qtyEl = pos.querySelector('[id^="qty"]');
        var priceEl = pos.querySelector('[id^="price"]');
        var q = parseFloat(qtyEl.value) || 0;
        var p = parseFloat(priceEl.value) || 0;
        sum += q * p;
    }
    document.getElementById('total').innerText = sum.toFixed(2).replace('.', ',') + ' â‚¬';
}

function submitForm(e) {
    e.preventDefault();
    
    saveCustomer();
    
    var items = [];
    var positions = document.querySelectorAll('.position');
    for (var i = 0; i < positions.length; i++) {
        var pos = positions[i];
        var desc = pos.querySelector('[id^="desc"]').value;
        var dur = pos.querySelector('[id^="dur"]').value;
        var qty = pos.querySelector('[id^="qty"]').value;
        var price = pos.querySelector('[id^="price"]').value;
        
        if (desc && qty && price) {
            var fullDesc = desc;
            if (dur) {
                fullDesc = desc + ' ' + dur;
                saveService(desc, dur);
            }
            items.push({description: fullDesc, quantity: qty, unit_price: price});
        }
    }
    
    if (items.length === 0) {
        alert('Bitte mindestens eine Position eingeben');
        return;
    }
    
    var data = {
        invoice_number: document.getElementById('inv_nr').value,
        invoice_date: document.getElementById('inv_date').value,
        client_name: document.getElementById('c_name').value,
        client_street: document.getElementById('c_street').value,
        client_postal_code: document.getElementById('c_plz').value,
        client_city: document.getElementById('c_city').value,
        items: items
    };
    
    fetch('/generate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(function(response) {
        if (response.ok) return response.blob();
        throw new Error('Fehler');
    })
    .then(function(blob) {
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'Rechnung_' + data.invoice_number + '.pdf';
        a.click();
    })
    .catch(function(err) {
        alert('Fehler beim Erstellen: ' + err.message);
    });
}

init();
</script>
</body>
</html>
